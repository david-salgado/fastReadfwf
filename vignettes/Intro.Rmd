---
title: "Fast reading fixed-width files in a standardised way"
author: "David Salgado"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Overview

Fixed-width files are still of extended usage in Official Statistics to disseminate anonymised microdata in plain text files. To read this microdata file a schema must be provided, which in most cases are different for different surveys and statistical programs.

This package provides a unified procedure to read these fixed-width files in a fast way using a standardised schema as an input parameter returning either a data.table or a tibble with the content of the file. The package does not provide a new reading function but only a common wrapper around the functions `fread` from the `data.table` package and `read_fwf` from the `readr` package.

The motivation is to provide a high-level scripting procedure to read this sort of files for any microdata set disseminated by a statistical office. In this vignette we illustrate the usage of this package with real data coming from the 2017 edition of the Spanish National Health Survey microdata set. 
The package also provides a format validation functionality for the values of each variable in the data set. The values are validated according to the format specified by the user in the schema through regular expressions.

# An illustrative example: the Spanish National Health Survey
The Spanish National Health Survey disseminates three anonymised microdata files together with their respective schemas corresponding to the questionnaires for adults, households, and household members under 18 years. The structure of these files and their schemas is different to those provided for other surveys. These files can be downloaded from the Spanish NSI's website. The microdata file for the adults together with its corresponding schema is included in this package for the 2017 edition.

Let us illustrate the philosophy of our proposed standardisation with the data files included in the package. Firstly, the schema for the questionnaire for adults is specified in an xlsx file with 5 sheet. Those with Spanish names contain the original schema specified in the downloaded file from the Spanish NSI's website. It is mainly for human consumption:

* Sheet Diseño de registro C. Adulto (*schema for the questionnaire for adults*) specifies the name, width, initial position, final position and description of each variable contained in the microdata file. It is presented in different blocks according to the semantics of the survey.

* Sheet Variables y valores (*variables and values*) specifies the core meaning of each variable and the supported values for each one.

* Sheet CNAE 2009 contains a condensed description of the Spanish version (CNAE) of the classification of economic activities NACE Rev. 2.

* Sheet CNO 2011 contains a condensed description of the Spanish version (CNO) of the classification of professional occupations (?).

Notice that we have created a new sheet with name *stSchema* fully oriented towards computer use with the information contained in the preceding 4 sheet in the following columns:

* **variable**: name of the variable.
* **width**: width of the variable in the microdata file.
* **initialPos**: initial position of the variable in the microdata file.
* **finalPos**: final position of the variable in the microdata file.
* **type**: type of the variable, with values either *char* or *num*.
* **valueRegEx**: regular expression for the accepted values of the variable.
* **description**: textual description of the variable.

This sheet can be straightforwardly read into a data.frame:

```{r Origxlsx, echo = TRUE, eval = TRUE, cache = TRUE}
library(openxlsx)
path <- system.file('extdata', package = 'fastReadfwf')
origSchema <- read.xlsx(file.path(path, 'SchemaSNHS.xlsx'), 
                        sheet = 'Diseño de Registro C. Adulto', 
                        colNames = TRUE)
str(origSchema)
```

Notice that this original schema in xlsx format is almost in the standardised way. Some short ad-hoc work needs to be conducted for this survey to build the standardised schema. The largest part of the work boils down to specify the regex for each variable:

```{r Stxlsx, echo = TRUE, eval = TRUE, cache = TRUE, dependson= 'Origxlsx'}
stSchema <- read.xlsx(file.path(path, 'SchemaSNHS.xlsx'), 
                        sheet = 'stSchema', 
                        colNames = TRUE)
str(stSchema)
```

Producing a data.table is now straightforward and fairly fast:

```{r readDT, echo = TRUE, eval = TRUE, cache = TRUE, dependson= 'Stxlsx'}
library(fastReadfwf)
library(data.table)
stSchema <- xlsxToSchema(file.path(path, 'SchemaSNHS.xlsx'), 'stSchema')
system.time(
  data.DT <- fread_fwf(file.path(path, 'MicroDataSNHS.txt'), 
                       stSchema, outFormat = 'data.table', perl = TRUE)
)
str(data.DT)
```

In the case of tibbles, we proceed in the same way:

```{r readTibble, echo = TRUE, eval = TRUE, cache = TRUE, dependson= 'Stxlsx'}
library(fastReadfwf)
library(tibble)
stSchema <- xlsxToSchema(file.path(path, 'SchemaSNHS.xlsx'), 'stSchema')
system.time(
  data.tibble <- fread_fwf(file.path(path, 'MicroDataSNHS.txt'), 
                       stSchema, outFormat = 'tibble')
)
data.tibble
```

Once data have been read, we can validate the format of the values of each variable.

```{r validTibble, echo = TRUE, eval = TRUE, cache = TRUE, dependson = 'readTibble'}
validateValues(data.tibble, stSchema)
```

# Some details

## The S4 class `StfwfSchema` 
